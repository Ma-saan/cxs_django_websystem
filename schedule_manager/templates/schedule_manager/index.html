{% extends 'layout.html' %}
{% load static %}

{% block content %}
<div class="schedule-container">
    <div class="schedule-header">
        <h1>生産予定管理システム</h1>
        <div class="action-buttons">
            <a href="{% url 'schedule_manager:import_csv' %}" class="btn btn-primary">
                <i class="fa fa-upload"></i> CSV一括インポート
            </a>
        </div>
    </div>
    
    <div class="container-flex">
        <!-- 既存のカレンダー表示部分（そのまま保持） -->
        <div class="calendar-container">
            <div class="calendar-controls">
                <button id="prev-month" class="btn btn-outline">前月</button>
                <h2 id="current-month">2025年3月</h2>
                <button id="next-month" class="btn btn-outline">次月</button>
            </div>
            
            <div class="calendar-grid" id="calendar-grid">
                <!-- カレンダーグリッドはJavaScriptで生成 -->
            </div>
        </div>
        
        <!-- 生産予定表示エリア（ドラッグ＆ドロップインターフェースに置き換え） -->
        <div id="production-board-root" class="schedule-data">
            <!-- React コンポーネントがここにマウントされます -->
            <div class="no-date-selected">
                <p>左のカレンダーから日付を選択してください</p>
            </div>
        </div>
    </div>
</div>

<!-- React コンポーネントを読み込むスクリプト -->
<script src="{% static 'build/production-board.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // カレンダーの処理（既存のコード）
        const calendarGrid = document.getElementById('calendar-grid');
        const currentMonthDisplay = document.getElementById('current-month');
        const prevMonthButton = document.getElementById('prev-month');
        const nextMonthButton = document.getElementById('next-month');
        
        // 現在の日付を設定
        let currentDate = new Date();
        
        // 月の名前（日本語）
        const monthNames = ["1月", "2月", "3月", "4月", "5月", "6月",
            "7月", "8月", "9月", "10月", "11月", "12月"];
        
        // カレンダーの描画（既存のコード）
        function renderCalendar() {
            // 現在の年月を表示
            currentMonthDisplay.textContent = `${currentDate.getFullYear()}年${monthNames[currentDate.getMonth()]}`;
            
            // カレンダーグリッドをクリア
            calendarGrid.innerHTML = '';
            
            // 曜日のヘッダーを追加
            const weekdays = ["日", "月", "火", "水", "木", "金", "土"];
            weekdays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // 月初の日付
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            // 月初の曜日（0-6, 0が日曜）
            const firstDayIndex = firstDay.getDay();
            
            // 月末の日付
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const lastDate = lastDay.getDate();
            
            // 前月の末日
            const prevLastDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0);
            const prevLastDate = prevLastDay.getDate();
            
            // 前月の日を追加
            for (let i = firstDayIndex; i > 0; i--) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day previous-month';
                dayElement.textContent = prevLastDate - i + 1;
                dayElement.style.opacity = '0.5';
                calendarGrid.appendChild(dayElement);
            }
            
            // 現在の月の日を追加
            for (let i = 1; i <= lastDate; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day current-month';
                dayElement.textContent = i;
                
                // 今日の日付をハイライト
                const today = new Date();
                if (i === today.getDate() && currentDate.getMonth() === today.getMonth() && 
                    currentDate.getFullYear() === today.getFullYear()) {
                    dayElement.style.backgroundColor = '#e8f4ff';
                    dayElement.style.borderColor = '#007bff';
                    dayElement.style.fontWeight = 'bold';
                }
                
                // 日付クリック時の処理 - ここを変更して React コンポーネントと連携
                dayElement.addEventListener('click', function() {
                    // 選択されているすべての日付のハイライトを解除
                    document.querySelectorAll('.calendar-day.selected').forEach(el => {
                        el.classList.remove('selected');
                        el.style.backgroundColor = '';
                    });
                    
                    // この日付をハイライト
                    dayElement.classList.add('selected');
                    dayElement.style.backgroundColor = '#cce5ff';
                    
                    // 選択された日付の予定をドラッグ＆ドロップインターフェースで表示
                    const selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
                    renderProductionBoard(selectedDate);
                });
                
                calendarGrid.appendChild(dayElement);
            }
            
            // 翌月の日を必要に応じて追加（6週間分の表示にするため）
            const totalDays = firstDayIndex + lastDate;
            const remainingCells = 42 - totalDays; // 6行 × 7列
            
            for (let i = 1; i <= remainingCells; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day next-month';
                dayElement.textContent = i;
                dayElement.style.opacity = '0.5';
                calendarGrid.appendChild(dayElement);
            }
        }
        
        // 選択された日付の生産予定をドラッグ＆ドロップインターフェースで表示
        function renderProductionBoard(date) {
            // Reactコンポーネントが存在するか確認
            if (typeof ProductionBoard !== 'undefined' && typeof ReactDOM !== 'undefined') {
                const container = document.getElementById('production-board-root');
                
                // 日付をフォーマット（YYYYMMDD）
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const formattedDate = `${year}${month}${day}`;
                
                // Reactコンポーネントをレンダリング
                const root = ReactDOM.createRoot(container);
                root.render(React.createElement(ProductionBoard, { selectedDate: formattedDate }));
            } else {
                console.error('ProductionBoard component not loaded correctly');
                
                // フォールバック: 従来の方法でデータを表示
                const container = document.getElementById('production-board-root');
                container.innerHTML = '<div class="loading-schedules">生産予定の取得中...</div>';
                
                // 日付をフォーマット（YYYYMMDD）
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const formattedDate = `${year}${month}${day}`;
                
                // APIからデータ取得（従来のコード）
                fetch(`/schedule_manager/api/schedules/?date=${formattedDate}`)
                    .then(response => response.json())
                    .then(data => {
                        // 従来の表示方法（一覧表示）
                        // ...
                    })
                    .catch(error => {
                        console.error('データ取得エラー:', error);
                        container.innerHTML = '<div class="error-message">データの取得に失敗しました。</div>';
                    });
            }
        }
        
        // 前月ボタンのイベント
        prevMonthButton.addEventListener('click', function() {
            currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
            renderCalendar();
        });
        
        // 次月ボタンのイベント
        nextMonthButton.addEventListener('click', function() {
            currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
            renderCalendar();
        });
        
        // 初期表示
        renderCalendar();
    });
</script>
{% endblock %}