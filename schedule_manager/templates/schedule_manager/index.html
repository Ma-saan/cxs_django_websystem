{% extends 'layout.html' %}
{% load static %}

{% block content %}
<div class="schedule-container">
    <div class="schedule-header">
        <h1>生産予定管理システム</h1>
        <div class="action-buttons">
            <a href="{% url 'schedule_manager:import_csv' %}" class="btn btn-primary">
                <i class="fa fa-upload"></i> CSV一括インポート
            </a>
        </div>
    </div>
    
    <!-- シンプルなカレンダー表示 -->
    <div class="calendar-container">
        <div class="calendar-controls">
            <button id="prev-month" class="btn btn-outline">前月</button>
            <h2 id="current-month">2025年3月</h2>
            <button id="next-month" class="btn btn-outline">次月</button>
        </div>
        
        <div class="calendar-grid" id="calendar-grid">
            <!-- カレンダーグリッドはJavaScriptで生成 -->
            <div class="loading">カレンダーを読み込み中...</div>
        </div>
    </div>
    
    <div class="schedule-data" id="schedule-data">
        <!-- ここに選択された日の予定が表示される -->
    </div>
</div>

<style>
    .schedule-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    .schedule-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    .btn {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        border-radius: 4px;
        text-decoration: none;
        font-weight: 500;
        cursor: pointer;
    }
    .btn-primary {
        background-color: #007bff;
        color: white;
        border: 1px solid #007bff;
    }
    .btn-outline {
        background-color: transparent;
        color: #007bff;
        border: 1px solid #007bff;
    }
    .calendar-container {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 20px;
    }
    .calendar-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
    }
    .calendar-day {
        aspect-ratio: 1;
        border: 1px solid #eee;
        padding: 5px;
        border-radius: 4px;
        display: flex;
        flex-direction: column;
    }
    .calendar-day-header {
        text-align: center;
        font-weight: bold;
        padding: 10px 0;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    .day-number {
        font-weight: bold;
        margin-bottom: 5px;
    }
    .day-schedule-count {
        font-size: 12px;
        background-color: #007bff;
        color: white;
        border-radius: 10px;
        padding: 2px 6px;
        align-self: flex-start;
    }
    .loading {
        grid-column: span 7;
        text-align: center;
        padding: 50px;
        color: #666;
    }
    .schedule-data {
        background-color: #f9f9f9;
        border-radius: 8px;
        padding: 20px;
        min-height: 200px;
    }
</style>

<!-- シンプルなカレンダー機能 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 要素の取得
    const calendarGrid = document.getElementById('calendar-grid');
    const currentMonthDisplay = document.getElementById('current-month');
    const prevMonthButton = document.getElementById('prev-month');
    const nextMonthButton = document.getElementById('next-month');
    
    // 現在の日付を設定
    let currentDate = new Date();
    
    // 月の名前（日本語）
    const monthNames = ["1月", "2月", "3月", "4月", "5月", "6月",
        "7月", "8月", "9月", "10月", "11月", "12月"];
    
    // カレンダーの描画
    function renderCalendar() {
        // 現在の年月を表示
        currentMonthDisplay.textContent = `${currentDate.getFullYear()}年${monthNames[currentDate.getMonth()]}`;
        
        // カレンダーグリッドをクリア
        calendarGrid.innerHTML = '';
        
        // 曜日のヘッダーを追加
        const weekdays = ["日", "月", "火", "水", "木", "金", "土"];
        weekdays.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'calendar-day-header';
            dayHeader.textContent = day;
            calendarGrid.appendChild(dayHeader);
        });
        
        // 月初の日付
        const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        // 月初の曜日（0-6, 0が日曜）
        const firstDayIndex = firstDay.getDay();
        
        // 月末の日付
        const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
        const lastDate = lastDay.getDate();
        
        // 前月の末日
        const prevLastDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0);
        const prevLastDate = prevLastDay.getDate();
        
        // 前月の日を追加
        for (let i = firstDayIndex; i > 0; i--) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day previous-month';
            dayElement.innerHTML = `<div class="day-number">${prevLastDate - i + 1}</div>`;
            dayElement.style.opacity = '0.5';
            calendarGrid.appendChild(dayElement);
        }
        
        // 現在の月の日を追加
        for (let i = 1; i <= lastDate; i++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day current-month';
            
            // 今日の日付をハイライト
            const today = new Date();
            if (i === today.getDate() && currentDate.getMonth() === today.getMonth() && 
                currentDate.getFullYear() === today.getFullYear()) {
                dayElement.style.backgroundColor = '#e8f4ff';
                dayElement.style.borderColor = '#007bff';
                dayElement.style.fontWeight = 'bold';
            }
            
            dayElement.innerHTML = `
                <div class="day-number">${i}</div>
                <div class="day-schedule-count">0</div>
            `;
            
            // 日付クリック時の処理
            dayElement.addEventListener('click', function() {
                // 選択されているすべての日付のハイライトを解除
                document.querySelectorAll('.calendar-day.selected').forEach(el => {
                    el.classList.remove('selected');
                    el.style.backgroundColor = '';
                });
                
                // この日付をハイライト
                dayElement.classList.add('selected');
                dayElement.style.backgroundColor = '#cce5ff';
                
                // ここで選択された日付の予定を表示する処理を追加
                const selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
                loadScheduleData(selectedDate);
            });
            
            calendarGrid.appendChild(dayElement);
        }
        
        // 翌月の日を必要に応じて追加（6週間分の表示にするため）
        const totalCells = 42; // 6行 × 7列
        const remainingCells = totalCells - (firstDayIndex + lastDate);
        
        for (let i = 1; i <= remainingCells; i++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day next-month';
            dayElement.innerHTML = `<div class="day-number">${i}</div>`;
            dayElement.style.opacity = '0.5';
            calendarGrid.appendChild(dayElement);
        }
    }
    
    // 選択された日付の予定データを読み込む
    function loadScheduleData(date) {
        const scheduleDataContainer = document.getElementById('schedule-data');
        scheduleDataContainer.innerHTML = `
            <h3>${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日の予定</h3>
            <div class="loading-schedules">予定を読み込み中...</div>
        `;
        
        // 日付をフォーマット（YYYYMMDD）
        const year = String(date.getFullYear());
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const formattedDate = `${year}${month}${day}`;
        
        console.log("データを取得する日付:", formattedDate);
        
        // APIからデータ取得
        fetch(`/schedule_manager/api/schedules/?date=${formattedDate}`)
            .then(response => {
                console.log("API応答ステータス:", response.status);
                return response.json();
            })
            .then(data => {
                if (data.length > 0) {
                    let scheduleHTML = `
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th>ライン</th>
                                    <th>品番</th>
                                    <th>製品名</th>
                                    <th>数量</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    data.forEach(item => {
                        scheduleHTML += `
                            <tr>
                                <td>${item.work_center_details ? item.work_center_details.display_name : '-'}</td>
                                <td>${item.product_number}</td>
                                <td>${item.product_name}</td>
                                <td>${item.production_quantity}</td>
                            </tr>
                        `;
                    });
                    
                    scheduleHTML += `
                            </tbody>
                        </table>
                    `;
                    
                    scheduleDataContainer.innerHTML = `
                        <h3>${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日の予定</h3>
                        ${scheduleHTML}
                    `;
                } else {
                    scheduleDataContainer.innerHTML = `
                        <h3>${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日の予定</h3>
                        <p>この日の予定はありません</p>
                    `;
                }
            })
            .catch(error => {
                console.error('データ取得エラー:', error);
                scheduleDataContainer.innerHTML = `
                    <h3>${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日の予定</h3>
                    <div class="error-message">
                        予定データの取得に失敗しました。
                    </div>
                `;
            });
    }
    
    // 前月ボタンのイベント
    prevMonthButton.addEventListener('click', function() {
        currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
        renderCalendar();
    });
    
    // 次月ボタンのイベント
    nextMonthButton.addEventListener('click', function() {
        currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
        renderCalendar();
    });
    
    // 初期表示
    renderCalendar();
    
    // 予定データの件数を更新（API呼び出し）
    fetch('/schedule_manager/api/schedules/')
        .then(response => response.json())
        .then(data => {
            console.log(`取得した全予定数: ${data.length}件`);
            
            // 日付ごとの予定件数をカウント
            const dayCounts = {};
            
            data.forEach(item => {
                if (item.production_date) {
                    // production_date形式に応じて処理
                    let dateKey;
                    
                    // YYYY-MM-DD形式の場合
                    if (typeof item.production_date === 'string' && item.production_date.includes('-')) {
                        dateKey = item.production_date;
                    } 
                    // 日付オブジェクトの場合
                    else if (item.production_date instanceof Date) {
                        const d = item.production_date;
                        dateKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    }
                    
                    if (dateKey) {
                        if (!dayCounts[dateKey]) {
                            dayCounts[dateKey] = 0;
                        }
                        dayCounts[dateKey]++;
                    }
                }
            });
            
            console.log('日付ごとの予定件数:', dayCounts);
            
            // カレンダーの日付に件数を表示
            const currentMonthStr = String(currentDate.getMonth() + 1).padStart(2, '0');
            const currentYearStr = String(currentDate.getFullYear());
            
            document.querySelectorAll('.calendar-day.current-month').forEach((dayEl, index) => {
                const dayNumber = index + 1;
                const dateStr = `${currentYearStr}-${currentMonthStr}-${String(dayNumber).padStart(2, '0')}`;
                
                console.log(`日付 ${dateStr} の件数を確認中`);
                const count = dayCounts[dateStr] || 0;
                const countEl = dayEl.querySelector('.day-schedule-count');
                
                if (countEl) {
                    countEl.textContent = count;
                    if (count === 0) {
                        countEl.style.display = 'none';
                    } else {
                        countEl.style.display = 'inline-block';
                    }
                }
            });
        })
        .catch(error => {
            console.error('予定データの取得に失敗しました:', error);
        });
});
</script>

<style>
    /* 追加スタイル */
    .schedule-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    .schedule-table th,
    .schedule-table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    .schedule-table th {
        background-color: #f2f2f2;
    }
    .error-message {
        color: #721c24;
        background-color: #f8d7da;
        padding: 15px;
        border-radius: 4px;
        margin-top: 15px;
    }
    .loading-schedules {
        text-align: center;
        padding: 20px;
        color: #666;
    }
</style>
{% endblock %}